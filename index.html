<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cultura Quiz</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" id="joinGameContainer">
        <h1>Cultura Quiz</h1>
        <input type="text" id="nicknameInput" placeholder="Inserisci il tuo nickname">
        <input type="text" id="roomInput" placeholder="Inserisci il codice stanza">
        <button id="joinBtn" onclick="joinGame()">Unisciti al gioco</button>
    </div>
    <div class="container" id="quizContainer" style="display: none;">
        <div id="question"></div>
        <ul id="options"></ul>
        <div id="result"></div>
        <div id="timer">Tempo rimasto: <span id="countdown">10</span> secondi</div>
        <button id="restartBtn" onclick="restartGame()" style="display: none;">Rigioca</button>
        <div id="scoreBoard"></div>
    </div>
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        let timer;
        let isGameStarted = false;

        function joinGame() {
            const nickname = document.getElementById('nicknameInput').value;
            const roomCode = document.getElementById('roomInput').value;
            if (nickname.trim() === '' || roomCode.trim() === '') {
                alert('Inserisci un nickname e un codice stanza validi per unirti al gioco.');
                return;
            }
            socket.emit('join room', { nickname, roomCode });
        }

        socket.on('room joined', () => {
            document.getElementById('joinGameContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
            if (!isGameStarted) {
                alert('Attendi il secondo giocatore per iniziare il gioco.');
            }
        });

        socket.on('quiz question', (question) => {
            document.getElementById('question').innerHTML = question.question;
            const optionsList = document.getElementById('options');
            optionsList.innerHTML = '';
            question.options.forEach((option, index) => {
                const li = document.createElement('li');
                li.textContent = option;
                li.onclick = () => {
                    clearTimeout(timer); // Cancella il timer quando si seleziona una risposta
                    socket.emit('quiz answer', { index, nickname: document.getElementById('nicknameInput').value });
                };
                optionsList.appendChild(li);
            });
            startTimer();
        });

        socket.on('quiz result', (result) => {
            document.getElementById('result').innerHTML = result;
        });

        socket.on('quiz end', (message) => {
            document.getElementById('result').innerHTML = `${message} ${document.getElementById('nicknameInput').value}!`;
            document.getElementById('restartBtn').style.display = 'block';
            clearTimeout(timer); // Cancella il timer alla fine del quiz
        });

        socket.on('restart game', () => {
            document.getElementById('result').innerHTML = '';
            document.getElementById('nicknameInput').value = ''; // Resetta il campo nickname
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('joinGameContainer').style.display = 'block';
            isGameStarted = false;
        });

        socket.on('update scoreboard', (scores) => {
            const scoreBoard = document.getElementById('scoreBoard');
            scoreBoard.innerHTML = '<h2>Punteggi:</h2>';
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');

            const headerRow = document.createElement('tr');
            const nicknameHeader = document.createElement('th');
            nicknameHeader.textContent = 'Nickname';
            const scoreHeader = document.createElement('th');
            scoreHeader.textContent = 'Punteggio';
            headerRow.appendChild(nicknameHeader);
            headerRow.appendChild(scoreHeader);
            thead.appendChild(headerRow);
            table.appendChild(thead);

            scores.forEach((score) => {
                const row = document.createElement('tr');
                const nicknameCell = document.createElement('td');
                nicknameCell.textContent = score.nickname;
                const scoreCell = document.createElement('td');
                scoreCell.textContent = score.score;
                row.appendChild(nicknameCell);
                row.appendChild(scoreCell);
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            scoreBoard.appendChild(table);
        });

        function startTimer() {
            let timeLeft = 10;
            updateTimer(timeLeft);
            timer = setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    updateTimer(timeLeft);
                }
                if (timeLeft === 0) {
                    clearInterval(timer);
                    document.getElementById('result').innerHTML = 'Tempo scaduto! La risposta Ã¨ sbagliata.';
                    socket.emit('quiz answer', { index: -1, nickname: document.getElementById('nicknameInput').value }); // Invia una risposta sbagliata quando il tempo scade
                }
            }, 1000);
        }

        function updateTimer(seconds) {
            document.getElementById('countdown').textContent = seconds;
        }

        function restartGame() {
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('result').innerHTML = '';
            socket.emit('restart game');
        }
    </script>
</body>
</html>